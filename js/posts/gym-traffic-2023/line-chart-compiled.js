'use strict';$(document).ready(function(){d3.csv('/datasets/gym-traffic/linechart-data.csv',function(a,b){if(a)throw a;b=processData(b),initGraphics(b)})});function initGraphics(a){// update line chart using week and day selections
function b(c){var f=d3.select('#pick-week').property('value'),h=d3.select('#pick-day').property('value'),i=d3.select('#pick-scale').property('value'),j=a.filter(function(k){return k.week==f&k.day==h});renderLineChart(j,i,c)}// render chart for the first time upon loading
d3.select('#pick-scale').on('change',function(){return b(!1)}),d3.select('#pick-week').on('change',function(){return b(!1)}).selectAll('option').data(d3.set(a,function(c){return c.week}).values()).enter().append('option').text(function(c){return c}).attr('value',function(c){return c}),d3.select('#pick-day').on('change',function(){return b(!1)}).selectAll('option').data(d3.set(a,function(c){return c.day}).values()).enter().append('option').text(function(c){return c}).attr('value',function(c){return c}),d3.select('#line-chart').append('svg').append('g'),window.yAbsoluteExtent=d3.extent(a,function(c){return c.n_people}),b(!0)}// render line chart
function renderLineChart(a,b,c){c||(d3.select('.y-axis').remove(),d3.select('.x-axis').remove(),d3.selectAll('.time-line').remove());// determine size of container and append svg
var f=$('#line-chart').outerWidth(),h=$('#line-chart').outerHeight(),i=400>f,j=d3.select('#line-chart').select('svg').attr('width',f).attr('height',i?300:400),k={left:30,right:30,bottom:60,top:30},l=j.attr('width')-k.left-k.right,m=j.attr('height')-k.top-k.bottom,n=j.select('g').attr('transform','translate('+k.left+','+k.top+')'),o=d3.extent(a,function(B){return B.hour_minute}),p=d3.scaleTime().domain(o).range([0,l]),q=d3.scaleLinear().domain(window.yAbsoluteExtent).range([m,0]),r=d3.scaleLinear().domain([0,100]).range([m,0]),s='absolute'==b?q:r;// detect mobile
// scales and axes
a.forEach(function(B){B.y_value='absolute'==b?B.n_people:B.n_people_rel}),n.append('g').attr('class','axis x-axis').attr('transform','translate(0,'+m+')').call(d3.axisBottom(p).ticks(d3.timeHour.every(i?6:3))),n.append('g').attr('class','axis y-axis').call(d3.axisLeft(s)),$('.line-chart .x-axis .tick text').first().addClass('invisible');// tooltip
var t=d3.tip().attr('class','heatchart-tip').html(function(B){var C=d3.timeFormat('%I:%M %p'),D='<span class=\'bold\'>'+C(B.data.hour_minute)+('wooden'==B.data.facility?' | Wooden':' | BFit')+'</span><br>';return 0==B.data.n_people?D+'<span class=\'bold\'>Closed</span>':D+'<span class=\'bold\'>'+B.data.n_people_rel+'%</span> relative to peak<br><span class=\'bold\'>'+B.data.n_people+'</span> people'});n.call(t);// lines
var u=d3.line().x(function(B){return p(B.hour_minute)}).y(function(B){return s(B.y_value)});n.append('path').datum(a.filter(function(B){return'wooden'==B.facility})).attr('d',u).attr('class','time-line wooden'),n.append('path').datum(a.filter(function(B){return'bfit'==B.facility})).attr('d',u).attr('class','time-line bfit');// mouse interaction
var v=d3.voronoi().x(function(B){return p(B.hour_minute)}).y(function(B){return s(B.y_value)}),w=n.append('g').attr('transform','translate(-100, -100)').attr('class','focus');w.append('circle').attr('r',4);var x=n.append('g').attr('class','voronoi'),y=v.extent([[0,0],[l,m]]).polygons(a);x.selectAll('path').data(y).enter().append('path').attr('d',function(B){return B?'M'+B.join('L')+'Z':null}).on('mouseover',function(C){t.show(C),w.attr('transform','translate('+p(C.data.hour_minute)+','+s(C.data.y_value)+')')}).on('mouseout',function(C){t.hide(C),w.attr('transform','translate(-100,-100)')}// legend
);var z=d3.scaleOrdinal().domain(['Wooden','BFit']).range(['#008fd5','#ffb81c']),A=d3.legendColor().shape('rect').shapeHeight(6).shapeWidth(25).shapePadding(25).orient('horizontal').scale(z);j.append('g').attr('class','line-legend').attr('transform',function(){return'translate(50,'+(i?270:370)+')'}),j.select('.line-legend').call(A)}function processData(a){var b=d3.timeParse('%H:%M');return a.forEach(function(c){c.hour_minute=b(Math.round(c.hour)+':'+Math.round(c.minute)),c.n_people=parseInt(c.n_people),c.n_people_rel=parseInt(100*+c.n_people_rel)}),a}
